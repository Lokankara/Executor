name: Java CI with Maven

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: 'zulu'
          cache: maven

      - name: Build with Maven
        run: mvn clean install

      - name: Run JaCoCo
        run: mvn jacoco:report

  copy-and-push:
    runs-on: ubuntu-latest

    needs: build

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v2
        with:
          repository: Lokankara/Report
          path: target-repo

      - name: Show site directory
        run: ls -la target/site/jacoco/

      - name: Check if jacoco-site directory exists and is not empty
        id: check_dir
        run: |
          if [ -d "target/site/jacoco/" ] && [ "$(ls -A target/site/jacoco/)" ]; then
            echo "dir_exists=true" >> $GITHUB_ENV
          else
            echo "dir_exists=false" >> $GITHUB_ENV
          fi
            
          if [ "$dir_exists" = "true" ]; then
            cd target-repo
            cp -r ../target/site/jacoco/* .
            git config --global user.email "poliyakpavlo@gmail.com"
            git config --global user.name "Lokankara"
            git add .
            git diff --quiet && git diff --staged --quiet || (git commit -m "Add Jacoco report"; git push)
          fi
          